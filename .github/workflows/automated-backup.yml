name: Automated Database Backup

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install PostgreSQL 17 client
        run: |
          # Add PostgreSQL APT repository
          sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          sudo apt-get update
          # Install PostgreSQL 17 client tools
          sudo apt-get install -y postgresql-client-17
          # Verify version
          pg_dump --version

      - name: Install dependencies
        working-directory: ./backend
        run: npm ci

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Create backup
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          BACKUP_ENCRYPTION_KEY: ${{ secrets.BACKUP_ENCRYPTION_KEY }}
          BACKUP_ENCRYPTION_SALT: ${{ secrets.BACKUP_ENCRYPTION_SALT }}
          BACKUP_DIR: ./backups
        run: |
          node scripts/backup-cli.js create

      - name: Upload backup to artifact storage
        uses: actions/upload-artifact@v4
        with:
          name: database-backup-${{ github.run_number }}
          path: backend/backups/*.enc
          retention-days: 30

      - name: Verify backup integrity
        working-directory: ./backend
        env:
          BACKUP_ENCRYPTION_KEY: ${{ secrets.BACKUP_ENCRYPTION_KEY }}
          BACKUP_ENCRYPTION_SALT: ${{ secrets.BACKUP_ENCRYPTION_SALT }}
          BACKUP_DIR: ./backups
        run: |
          LATEST_BACKUP=$(ls -t backups/*.enc | head -1)
          node scripts/backup-cli.js verify $(basename $LATEST_BACKUP)

      - name: Cleanup old backups
        working-directory: ./backend
        env:
          BACKUP_ENCRYPTION_KEY: ${{ secrets.BACKUP_ENCRYPTION_KEY }}
          BACKUP_ENCRYPTION_SALT: ${{ secrets.BACKUP_ENCRYPTION_SALT }}
          BACKUP_DIR: ./backups
          BACKUP_RETENTION_DAYS: 30
        run: |
          node scripts/backup-cli.js cleanup

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Automated Backup Failed',
              body: `Automated database backup failed on ${new Date().toISOString()}\n\nWorkflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['backup', 'critical']
            })

      - name: Send success notification
        if: success()
        run: |
          echo "âœ… Backup completed successfully"
          # TODO: Add Slack/email notification
